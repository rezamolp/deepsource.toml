# ๐ง ุฎูุงุตู ุฑูุน ูุดฺฉูุงุช Guardian Bot

## ๐ ูุดฺฉูุงุช ุดูุงุณุง ู ุฑูุน ุดุฏู

### ๐จ ูุดฺฉูุงุช ุจุญุฑุงู (Critical Issues)

#### 1. **ROT-NOP** - ฺุฑุฎุด ูููู ฺฉุงุฐุจ
**ูุดฺฉู:** ูพุงู ููููุช ุจุฏูู ุชุบุฑ ูุงูุน ููฺฉ  
**ุฑุงูโุญู:** 
- ุงุถุงูู ฺฉุฑุฏู ุชุงุจุน `verify_username_change` ุฏุฑ `telethon_manager.py`
- ุฑุงุณุชโุขุฒูุง ุงุฒ ุชูฺฏุฑุงู ุจุนุฏ ุงุฒ ูุฑ ุชุบุฑ
- ุนุฏู ุซุจุช ููููุช ุจุฏูู ุชุฃุฏ

#### 2. **CHATID-MISMATCH** - ุดูุงุณู ฺฉุงูุงู ุงุดุชุจุงู
**ูุดฺฉู:** ุงุณุชูุงุฏู ุงุฒ chat_id ุงุฏูู ุจู ุฌุง id ฺฉุงูุงู  
**ุฑุงูโุญู:**
- ุชุงุจุน `resolve_channel_entity` ุจุฑุง ุญู ุฏูู ฺฉุงูุงู
- ูพุดุชุจุงู ุงุฒ ูุฑูุชโูุง ูุฎุชูู ูุฑูุฏ (@name, t.me/link)
- ุจุฑุฑุณ ููุน entity (ููุท Channel)

#### 3. **API-CHOICE** - ุงูุชุฎุงุจ API ุงุดุชุจุงู
**ูุดฺฉู:** ุงุณุชูุงุฏู ุงุฒ Bot API ุจู ุฌุง Telethon  
**ุฑุงูโุญู:**
- ุงุณุชูุงุฏู ุงูุญุตุงุฑ ุงุฒ Telethon ุจุฑุง ุชุบุฑ ููฺฉ
- ูพุงุฏูโุณุงุฒ ฺฉุงูู `change_channel_link` ุจุง Telethon
- ูุฏุฑุช ุฎุทุงูุง Telethon

### โ๏ธ ูุดฺฉูุงุช ููู (Major Issues)

#### 4. **PERM-MISSING** - ุนุฏู ุจุฑุฑุณ ูุฌูุฒูุง
**ูุดฺฉู:** ุนุฏู ุจุฑุฑุณ ูุฌูุฒ "ุชุบุฑ ุงุทูุงุนุงุช"  
**ุฑุงูโุญู:**
- ุชุงุจุน `check_channel_permissions` ุจุฑุง ุจุฑุฑุณ ฺฉุงูู ูุฌูุฒูุง
- ุจุฑุฑุณ `is_admin`, `can_change_info`, `can_view_participants`
- ูพุงูโูุง ุฎุทุง ุฏูู

#### 5. **USERNAME-OCC** - ุนุฏู ูุฏุฑุช ูุงูโูุง ุงุดุบุงู ุดุฏู
**ูุดฺฉู:** ุดฺฉุณุช ุฎุงููุด ุฏุฑ ุตูุฑุช ุงุดุบุงู ุจูุฏู ูุงู  
**ุฑุงูโุญู:**
- ุญููู ูพุณููุฏูุง (guardian1 ุชุง guardian100)
- ูุฏุฑุช `UsernameOccupiedError` ู `UsernameInvalidError`
- ุงุฏุงูู ุชูุงุด ุจุง ูพุณููุฏ ุจุนุฏ

#### 6. **AWAIT-MISS** - ุนุฏู ุงูุชุธุงุฑ ุจุฑุง ุนููุงุช async
**ูุดฺฉู:** ุนุฏู await ุจุฑุง callูุง Telethon  
**ุฑุงูโุญู:**
- ุงุทููุงู ุงุฒ await ุชูุงู ุนููุงุช async
- ูุฏุฑุช ุตุญุญ `UpdateUsernameRequest`
- ุงูุชุธุงุฑ ุจุฑุง ูุชุฌู ูุจู ุงุฒ ุงุฏุงูู

#### 7. **STATUS-FALSEPOS** - ูุถุนุช ฺฉุงุฐุจ
**ูุดฺฉู:** ฺฏุฒุงุฑุด ููููุช ุจุฑ ุงุณุงุณ ุชูููุชุฑ ุฏุงุฎู  
**ุฑุงูโุญู:**
- ุฎูุงูุฏู ูุถุนุช ูุงูุน ุงุฒ ุชูฺฏุฑุงู
- ุชุงุจุน `get_channel_current_state`
- ููุงุณู ุจุง ุชูููุชุฑ ุฏุงุฎู

### ๐ ูุดฺฉูุงุช ูุดุงูุฏูโูพุฐุฑ (Observability Issues)

#### 8. **LOG-GAPS** - ูุงฺฏโูุง ูุงูุต
**ูุดฺฉู:** ุนุฏู ุซุจุช reason ุฏูู ุดฺฉุณุชโูุง  
**ุฑุงูโุญู:**
- ูุงฺฏโูุง ุณุงุฎุชุงุฑุงูุชู ุจุง `trace_id`
- ุซุจุช reason ุฏูู ุจุฑุง ูุฑ ุฎุทุง
- ูุงฺฏ ฺฉุงูู ุนููุงุชโูุง

## ๐ ูฺฺฏโูุง ุฌุฏุฏ ุงุถุงูู ุดุฏู

### 1. **ูุงุชุฑุณ ุณูุงูุช ฺฉุงูุงู**
```python
# ุฏุฑ handlers/messages.py
async def _get_health_matrix(channel_input: str) -> dict:
    # ุจุฑุฑุณ ฺฉุงูู ูุฌูุฒูุง ู ูุถุนุช
    # ููุงุด ูุถุนุช ุจุง ุงููุฌโูุง
    # ุชุดุฎุต ูุดฺฉูุงุช ุงุญุชูุงู
```

### 2. **ุณุณุชู ุฑุงุณุชโุขุฒูุง**
```python
# ุฏุฑ services/telethon_manager.py
async def verify_username_change(channel_id: int, target_username: str) -> bool:
    # ุชุฃุฏ ุชุบุฑ ุงุฒ ุชูฺฏุฑุงู
    # ููุงุณู username ูุนู ุจุง ูุฏู
    # ฺฏุฒุงุฑุด ูุชุฌู
```

### 3. **ุขูุงุฑ ุชูุตู ฺุฑุฎุด**
```python
# ุฏุฑ services/channel.py
_rotation_stats = {
    "success_count": 0,
    "fail_count": 0,
    "last_suffix": 0,
    "last_rotation_time": None
}
```

### 4. **ุณุณุชู ุงุนูุงู ูพุดุฑูุชู**
```python
# ุฏุฑ services/link_rotator.py
async def notify_rotation_success(admin_id: int, trace_id: str, bot, channel_info: Dict[str, Any]):
    # ุงุนูุงู ููููุช ุจุง ุฌุฒุฆุงุช ฺฉุงูู
    # ุดุงูู ููฺฉ ุฌุฏุฏ ู ุขูุงุฑ

async def notify_rotation_failure(admin_id: int, trace_id: str, bot, channel_info: Dict[str, Any], reason: str):
    # ุงุนูุงู ุดฺฉุณุช ุจุง ุฑุงูููุง
    # ุดุงูู ุฏูู ุฏูู ู ูพุดููุงุฏุงุช
```

### 5. **ูุฏุฑุช ุฎุทุง ุฌุงูุน**
```python
# ฺฉูุงุณโูุง ุฎุทุง ุฌุฏุฏ
class TelethonManagerError(Exception): pass
class ChannelResolutionError(TelethonManagerError): pass
class PermissionError(TelethonManagerError): pass
class UsernameChangeError(TelethonManagerError): pass
```

## ๐ ุชุบุฑุงุช ุฏุฑ ูุงูโูุง

### ูุงูโูุง ุงุตู ุชุบุฑ ุงูุชู:

1. **`services/telethon_manager.py`** - ุจุงุฒููุณ ฺฉุงูู
   - ูุฏุฑุช ุงุชุตุงู Telethon
   - ุญู ุฏูู ฺฉุงูุงู
   - ุจุฑุฑุณ ูุฌูุฒูุง
   - ุฑุงุณุชโุขุฒูุง ุชุบุฑุงุช

2. **`services/channel.py`** - ุจุงุฒููุณ ฺฉุงูู
   - ูุฏุฑุช ฺุฑุฎุด ููฺฉ
   - ุขูุงุฑฺฏุฑ
   - ูุฏุฑุช ุฎุทุง

3. **`handlers/messages.py`** - ุจูุจูุฏ ูุงุจู ุชูุฌู
   - ูุงุชุฑุณ ุณูุงูุช
   - ุจุงุฒุฎูุฑุฏ ุชูุตู
   - ูุฏุฑุช ุจูุชุฑ ูุฑูุฏ

4. **`handlers/callbacks.py`** - ุจูุจูุฏ ูุงุจู ุชูุฌู
   - ูุถุนุช ูุงูุน ุงุฒ ุชูฺฏุฑุงู
   - ุขูุงุฑ ุชูุตู
   - ุจุฑุฑุณ ุณูุงูุช

5. **`services/link_rotator.py`** - ุจุงุฒููุณ ฺฉุงูู
   - ุณุณุชู ุงุนูุงู ูพุดุฑูุชู
   - ูุฏุฑุช retry
   - ูพุงูโูุง ุฑุงูููุง

6. **`utils/keyboards.py`** - ุจูุจูุฏ
   - ุฏฺฉููโูุง ุฌุฏุฏ
   - ููู ุจูุชุฑ

7. **`deepsource.toml`** - ูุงู ุฌุฏุฏ
   - ุชูุธูุงุช ุชุญูู ฺฉุฏ
   - ููุงูู ุงููุช

8. **`README.md`** - ุจุงุฒููุณ ฺฉุงูู
   - ูุณุชูุฏุงุช ูุดฺฉูุงุช ุฑูุน ุดุฏู
   - ุฑุงูููุง ุงุณุชูุงุฏู
   - ูฺฺฏโูุง ุฌุฏุฏ

## ๐งช ุชุณุชโูุง ุฌุฏุฏ

### ูุงู ุชุณุช ุฌุฏุฏ: `guardian_tests/test_link_rotator_fixed.py`
- ุชุณุช ุญู ุฏูู ฺฉุงูุงู
- ุชุณุช ุจุฑุฑุณ ูุฌูุฒูุง
- ุชุณุช ุฑุงุณุชโุขุฒูุง
- ุชุณุช ูุฏุฑุช ุฎุทุง
- ุชุณุช ุขูุงุฑฺฏุฑ

## ๐ ุจูุจูุฏูุง ุนููฺฉุฑุฏ

### 1. **ฺฉุงูุด ุฏุฑุฎูุงุณุชโูุง ุบุฑุถุฑูุฑ**
- ฺฉุด ฺฉุฑุฏู ุงุทูุงุนุงุช ฺฉุงูุงู
- ุจุฑุฑุณ ูุฌูุฒูุง ูุจู ุงุฒ ุงูุฏุงู
- ูุฏุฑุช ุจูุชุฑ ุฎุทุงูุง

### 2. **ุจูุจูุฏ ุชุฌุฑุจู ฺฉุงุฑุจุฑ**
- ูพุงูโูุง ูุงุถุญ ู ุฑุงูููุง
- ููุงุด ูพุดุฑูุช ุนููุงุช
- ุจุงุฒุฎูุฑุฏ ููุฑ

### 3. **ูุธุงุฑุช ุจูุชุฑ**
- ูุงฺฏโูุง ุณุงุฎุชุงุฑุงูุชู
- ุขูุงุฑ ุนููฺฉุฑุฏ
- ุชุดุฎุต ูุดฺฉูุงุช

## ๐ ุจูุจูุฏูุง ุงููุช

### 1. **ุจุฑุฑุณ ูุฌูุฒูุง**
- ุชุฃุฏ ุงุฏูู ุจูุฏู
- ุจุฑุฑุณ ูุฌูุฒ ุชุบุฑ ุงุทูุงุนุงุช
- ุงุนุชุจุงุฑุณูุฌ ุฏุณุชุฑุณ

### 2. **ูุฏุฑุช ุฌูุณู**
- ุฐุฎุฑู ุงูู session
- ูุฏุฑุช ุฎุทุงูุง ุงุญุฑุงุฒ ููุช
- ูุญุงูุธุช ุงุฒ ุงุทูุงุนุงุช ุญุณุงุณ

## ๐ ูุญูู ุงุณุชูุงุฏู ุงุฒ ูุณุฎู ุฌุฏุฏ

### 1. **ุชูุธู ุงููู**
```bash
# ูุตุจ ูุงุจุณุชฺฏโูุง
pip install -r requirements.txt

# ุชูุธู ูุชุบุฑูุง ูุญุท
cp .env.example .env
# ูุฑุงุด ูุงู .env
```

### 2. **ุชูุธู Telethon**
1. ุฏฺฉูู "ุงูุฒูุฏู ุงฺฉุงูุช Telethon" ุฑุง ุจุฒูุฏ
2. ุดูุงุฑู ุชููู ุฑุง ูุงุฑุฏ ฺฉูุฏ
3. ฺฉุฏ ุชุฃุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ

### 3. **ุชูุธู ฺฉุงูุงู**
1. ุฏฺฉูู "ุซุจุช ฺฉุงูุงู" ุฑุง ุจุฒูุฏ
2. ูุงู ฺฉุงุฑุจุฑ ฺฉุงูุงู ุฑุง ูุงุฑุฏ ฺฉูุฏ
3. ูุงุชุฑุณ ุณูุงูุช ุฑุง ุจุฑุฑุณ ฺฉูุฏ

### 4. **ฺุฑุฎุด ููฺฉ**
1. ุฏฺฉูู "ุชุบุฑ ููฺฉ ุฏุณุช" ุฑุง ุจุฒูุฏ
2. ูุงู ูพุงู ุฑุง ูุงุฑุฏ ฺฉูุฏ
3. ููุชุธุฑ ูุชุฌู ุจุงุดุฏ

## ๐ ูุธุงุฑุช ู ุนุจโุงุจ

### ุฏฺฉููโูุง ุฌุฏุฏ:
- **ุจุฑุฑุณ ุณูุงูุช:** ุชุดุฎุต ูุดฺฉูุงุช ุณุณุชู
- **ุขูุงุฑ ฺุฑุฎุด:** ูุดุงูุฏู ุนููฺฉุฑุฏ ุณุณุชู
- **ูุถุนุช ุฑุจุงุช:** ุงุทูุงุนุงุช ุฌุงูุน ูุถุนุช

### ูุงฺฏโูุง ุณุงุฎุชุงุฑุงูุชู:
```python
logger.info("rotation_success", extra={
    "channel_id": channel_id,
    "new_username": new_username,
    "trace_id": trace_id,
    "verified": True
})
```

### ฺฉุฏูุง ุฎุทุง:
- `permission_error`: ูุดฺฉู ูุฌูุฒ
- `username_occupied`: ูุงู ุงุดุบุงู ุดุฏู
- `verification_failed`: ุนุฏู ุชุฃุฏ ุชุบุฑ
- `telethon_error`: ูุดฺฉู ุงุชุตุงู

## โ ูุชุฌูโฺฏุฑ

ุชูุงู ูุดฺฉูุงุช ุดูุงุณุง ุดุฏู ุฑูุน ุดุฏูโุงูุฏ:

1. โ **ROT-NOP**: ุฑุงุณุชโุขุฒูุง ุงุถุงูู ุดุฏ
2. โ **CHATID-MISMATCH**: ุญู ุฏูู ฺฉุงูุงู ูพุงุฏูโุณุงุฒ ุดุฏ
3. โ **API-CHOICE**: ุงุณุชูุงุฏู ุงูุญุตุงุฑ ุงุฒ Telethon
4. โ **PERM-MISSING**: ุจุฑุฑุณ ฺฉุงูู ูุฌูุฒูุง
5. โ **USERNAME-OCC**: ูุฏุฑุช ูุงูโูุง ุงุดุบุงู ุดุฏู
6. โ **AWAIT-MISS**: ูุฏุฑุช ุตุญุญ async
7. โ **STATUS-FALSEPOS**: ูุถุนุช ูุงูุน ุงุฒ ุชูฺฏุฑุงู
8. โ **LOG-GAPS**: ูุงฺฏโูุง ฺฉุงูู

### ูฺฺฏโูุง ุงุถุงู:
- ๐ ูุงุชุฑุณ ุณูุงูุช ฺฉุงูุงู
- ๐ ุณุณุชู ุฑุงุณุชโุขุฒูุง
- ๐ ุขูุงุฑ ุชูุตู
- ๐ ุณุณุชู ุงุนูุงู ูพุดุฑูุชู
- ๐ ูุฏุฑุช ุฎุทุง ุฌุงูุน
- ๐ ุชุณุชโูุง ฺฉุงูู

**ูุณุฎู:** 2.0.0  
**ูุถุนุช:** ุชููุฏ ุขูุงุฏู  
**ุชุงุฑุฎ:** 2024